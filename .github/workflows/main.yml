name: setup CRD (XFCE - Faster Install)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'RAW Chrome Remote Desktop Authorization Code (The string inside --code="..." from the headless setup page)'
        required: true
        type: string
      crd_pin:
        description: 'Google Chrome Remote Desktop PIN (6-digit number)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      USERNAME: runner

    steps:
      - uses: actions/checkout@v4

      - name: Setup User and Install XFCE + CRD
        run: |
          echo ">>> Setting up user and installing XFCE + CRD..."
          
          # Set up user for sudo
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

          # Update and install CRD dependencies + XFCE
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq xfce4 xfce4-terminal dbus-x11 wget jq

          # 1. Download and install CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget https://dl.google.com/linux/direct/$CRD_DEB
          sudo dpkg --install $CRD_DEB || sudo apt install -f -y -qq
          
          # 2. Configure the session to use XFCE
          echo "exec /usr/bin/xfce4-session" | sudo tee /etc/chrome-remote-desktop-session
          
          # 3. Add the runner user to the CRD group
          sudo groupadd -f chrome-remote-desktop
          sudo usermod -aG chrome-remote-desktop ${USERNAME}

      - name: Authorize and Start CRD Service
        run: |
          echo ">>> Starting Chrome Remote Desktop Service..."
          
          # Manually construct the full command using the two separate inputs.
          # The start-host command is more reliable than the chrome-remote-desktop client.
          CRD_COMMAND="DISPLAY= /opt/google/chrome-remote-desktop/start-host \
                       --code=\"${{ inputs.crd_code }}\" \
                       --redirect-url=\"https://remotedesktop.google.com/_/oauthredirect\" \
                       --name=$(hostname) \
                       --pin=\"${{ inputs.crd_pin }}\""
          
          echo "Executing CRD command (code and pin redacted from log)..."
          
          # Execute the command as the 'runner' user.
          sudo -u ${USERNAME} sh -c "${CRD_COMMAND}"
          
          echo "CRD Service Started."

      - name: Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "1. Go to: https://remotedesktop.google.com/access"
          echo "2. Connect using the PIN you provided."
          echo
          echo ">>> Keeping runner alive for connection."
          while true; do sleep 600; done
