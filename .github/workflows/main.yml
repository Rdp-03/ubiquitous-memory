name: setup KDE Plasma + CRD

on:
  workflow_dispatch:
    inputs:
      crd_full_command:
        description: 'Paste the FULL command string generated by the CRD headless setup page (e.g., DISPLAY= /opt/google/chrome-remote-desktop/... --code="..." --name=...)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      USERNAME: runner

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + Chrome Remote Desktop
        run: |
          echo ">>> Installing KDE Plasma Desktop & CRD..."
          sudo apt-get update -qq
          # Install KDE and required dependencies
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop xorg dbus-x11 wget jq
          
          # 1. Download and install CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget https://dl.google.com/linux/direct/$CRD_DEB
          sudo dpkg --install $CRD_DEB || sudo apt install -f -y -qq
          
          # 2. Configure the session to use KDE Plasma
          echo "exec /usr/bin/startplasma-x11" | sudo tee /etc/chrome-remote-desktop-session
          
          # 3. Add the runner user to the CRD group 
          sudo groupadd -f chrome-remote-desktop
          sudo usermod -aG chrome-remote-desktop ${USERNAME}

      - name: Authorize and Start CRD Service (Full Command Execution)
        run: |
          echo ">>> Starting Chrome Remote Desktop Service..."
          
          # Store the full command string in a shell variable.
          FULL_CRD_COMMAND="${{ inputs.crd_full_command }}"
          
          echo "Executing full CRD command (code redacted from log)..."
          
          # Execute the command as the 'runner' user.
          # This runs the full string: DISPLAY= /opt/google/chrome-remote-desktop/...
          sudo -u ${USERNAME} sh -c "${FULL_CRD_COMMAND}"
          
          echo "CRD Service Started. The runner should now appear in your Chrome Remote Desktop dashboard."

      - name: Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "1. Go to: https://remotedesktop.google.com/access"
          echo "2. Find the new desktop session linked to your Google Account."
          echo "3. Connect using your PIN."
          echo
          echo ">>> Keeping runner alive for connection."
          while true; do sleep 600; done
