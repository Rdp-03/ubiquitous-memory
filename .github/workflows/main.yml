name: setup KDE Plasma + CRD

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'RAW Chrome Remote Desktop Authorization Code (The string inside --code="..." from the headless setup page)'
        required: true
        type: string
      crd_pin:
        description: 'Google Chrome Remote Desktop PIN (6-digit number)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      USERNAME: runner

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + Chrome Remote Desktop (FIXED Group)
        run: |
          echo ">>> Installing KDE Plasma Desktop & CRD..."
          sudo apt-get update -qq
          # Install KDE and required dependencies
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop xorg dbus-x11 wget jq
          
          # 1. Download and install CRD
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget https://dl.google.com/linux/direct/$CRD_DEB
          sudo dpkg --install $CRD_DEB || sudo apt install -f -y -qq
          
          # 2. Configure the session to use KDE Plasma
          echo "exec /usr/bin/startplasma-x11" | sudo tee /etc/chrome-remote-desktop-session
          
          # 3. Add the runner user to the CRD group 
          # FIX: Explicitly ensure the group exists before adding the user
          sudo groupadd -f chrome-remote-desktop
          sudo usermod -aG chrome-remote-desktop ${USERNAME}

      - name: Authorize and Start CRD Service (FIXED Command Execution)
        run: |
          echo ">>> Starting Chrome Remote Desktop Service..."
          
          # 1. Store the sensitive inputs in shell variables to prevent shell expansion issues.
          CRD_CODE="${{ inputs.crd_code }}"
          CRD_PIN="${{ inputs.crd_pin }}"
          
          # 2. Construct the clean command.
          CRD_COMMAND="/opt/google/chrome-remote-desktop/chrome-remote-desktop --code=${CRD_CODE} --pin=${CRD_PIN}"
          
          echo "Executing CRD command (code and pin redacted from log)..."
          
          # 3. Execute the command as the 'runner' user.
          # Note: The command must be wrapped in quotes for sudo -u sh -c
          sudo -u ${USERNAME} sh -c "${CRD_COMMAND}"
          
          echo "CRD Service Started. The runner should now appear in your Chrome Remote Desktop dashboard."

      - name: Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "1. Go to: https://remotedesktop.google.com/access"
          echo "2. Find the new desktop session linked to your Google Account."
          echo "3. Connect using the PIN you provided."
          echo
          echo ">>> Keeping runner alive for connection."
          # Loop to keep the action running
          while true; do sleep 600; done
