name: setup KDE Plasma + CRD

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'RAW Chrome Remote Desktop Authorization Code (The string inside --code="..." from the headless setup page)'
        required: true
        type: string
      crd_pin:
        description: 'Google Chrome Remote Desktop PIN (6-digit number)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      USERNAME: runner

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + Chrome Remote Desktop
        run: |
          echo ">>> Installing KDE Plasma Desktop & CRD..."
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop xorg dbus-x11 wget jq
          
          CRD_DEB="chrome-remote-desktop_current_amd64.deb"
          wget https://dl.google.com/linux/direct/$CRD_DEB
          sudo dpkg --install $CRD_DEB || sudo apt install -f -y -qq
          
          echo "exec /usr/bin/startplasma-x11" | sudo tee /etc/chrome-remote-desktop-session
          
          sudo groupadd -f chrome-remote-desktop
          sudo usermod -aG chrome-remote-desktop ${USERNAME}

      - name: Authorize and Start CRD Service (Two Inputs)
        run: |
          echo ">>> Starting Chrome Remote Desktop Service..."
          
          # Manually construct the full command using the two separate inputs,
          # including the necessary DISPLAY= and start-host components.
          CRD_COMMAND="DISPLAY= /opt/google/chrome-remote-desktop/start-host \
                       --code=\"${{ inputs.crd_code }}\" \
                       --redirect-url=\"https://remotedesktop.google.com/_/oauthredirect\" \
                       --name=$(hostname) \
                       --pin=\"${{ inputs.crd_pin }}\""
          
          echo "Executing CRD command (code and pin redacted from log)..."
          
          # Execute the command as the 'runner' user.
          sudo -u ${USERNAME} sh -c "${CRD_COMMAND}"
          
          echo "CRD Service Started."

      - name: Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "1. Go to: https://remotedesktop.google.com/access"
          echo "2. Find the new desktop session linked to your Google Account."
          echo "3. Connect using the 6-digit PIN you provided."
          echo
          echo ">>> Keeping runner alive for connection."
          while true; do sleep 600; done
