name: setup KDE Plasma + ngrok + VNC (for CRD Install)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      USERNAME: runner
      # Note: VNC uses a separate password (vncpasswd) but we'll reuse the runner password for simplicity
      PASSWORD: runner
      VNC_PORT: 5901

    steps:
      - uses: actions/checkout@v4

      - name: Set Runner User Credentials
        run: |
          # Set the password for the runner user
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + VNC Server
        run: |
          echo ">>> Installing KDE Plasma Desktop & TightVNC Server..."
          sudo apt-get update -qq
          # Install KDE, xorg, and TightVNC
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq kde-plasma-desktop xorg dbus-x11 tightvncserver wget jq

          # 1. Configure VNC Startup Script for KDE Plasma
          mkdir -p /home/${USERNAME}/.vnc
          VNC_STARTUP_SCRIPT="/home/${USERNAME}/.vnc/xstartup"
          
          # Create the xstartup file to launch KDE
          echo '#!/bin/bash' | sudo tee ${VNC_STARTUP_SCRIPT}
          echo 'xrdb $HOME/.Xresources' | sudo tee -a ${VNC_STARTUP_SCRIPT}
          echo 'startkde' | sudo tee -a ${VNC_STARTUP_SCRIPT}
          
          sudo chmod +x ${VNC_STARTUP_SCRIPT}
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc

          # 2. Set the VNC password (required by VNC server)
          # We execute vncpasswd as the runner user using their PASSWORD environment variable
          # The 'yes' command automates the input process, setting the password and skipping verification
          echo "Setting VNC password for ${USERNAME}..."
          sudo -u ${USERNAME} sh -c "mkdir -p /home/${USERNAME}/.vnc && echo '${PASSWORD}' | vncpasswd -f > /home/${USERNAME}/.vnc/passwd"
          sudo -u ${USERNAME} chmod 600 /home/${USERNAME}/.vnc/passwd
          
          # 3. Start VNC Server
          echo "Starting VNC Server on port ${VNC_PORT}..."
          sudo -u ${USERNAME} tightvncserver -geometry 1280x800 :1


      - name: Setup ngrok tunnel
        run: |
          echo ">>> Setting up ngrok tunnel on VNC port ${VNC_PORT}..."
          
          # Install ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.zip -o ngrok.zip
          unzip ngrok.zip
          
          # Authenticate ngrok (NGROK_AUTHTOKEN must be in secrets)
          ./ngrok authtoken "${NGROK_AUTHTOKEN}"
          
          # Start ngrok tunnel in the background
          ./ngrok tcp ${VNC_PORT} --log stdout --log-format json --region in &

          # Wait for ngrok to get the URL
          NGROK_API_URL="http://127.0.0.1:4040/api/tunnels"
          for i in {1..10}; do
            TUNNELS_JSON=$(curl -s $NGROK_API_URL)
            if [ $? -eq 0 ] && echo "$TUNNELS_JSON" | grep -q "public_url"; then
              break
            fi
            sleep 5
          done

          # Extract the VNC connection address (hostname and port)
          VNC_ADDRESS=$(echo "$TUNNELS_JSON" | jq -r '.tunnels[] | select(.proto=="tcp") | .public_url' | sed 's/tcp:\/\///')
          
          if [ -z "$VNC_ADDRESS" ]; then
            echo "Failed to get ngrok VNC address."
            exit 1
          fi

          echo "VNC_ADDRESS=${VNC_ADDRESS}" >> $GITHUB_ENV


      - name: Connection + Keep Alive
        run: |
          echo "=== FINAL CONNECTION INFO ==="
          echo "VNC Address (HOST:PORT): ${VNC_ADDRESS}"
          echo "VNC Password (The value of 'PASSWORD' environment variable): ${PASSWORD}"
          echo
          echo ">>> Connect with any VNC client (e.g., RealVNC Viewer) using the address above."
          echo ">>> Once connected, you can open a browser/terminal and install/authorize CRD."
          
          # Loop to keep the action running
          while true; do sleep 600; done
